{% extends "base.html" %}
{% block content %}
<style>
    h1 {
        font-family: 'Jura', sans-serif; 
        font-weight: bold; 
        text-align: center;
    }
    #mapFrame {
        border-radius: 10px; 
    }
    h2 {
        font-family: 'Jura', sans-serif; 
        font-weight: bold; 
        margin-top: 40px;
        margin-bottom: 20px;
        text-align: center;
    }
    h3 {
        font-family: 'Jura', sans-serif; 
        font-weight: bold;
        margin-top: 50px;
        text-align: center;
    }
    h4{
        font-family: 'Jura', sans-serif; 
        font-weight: bold;
        margin-top: 50px;
        text-align: center;
        color: #36A2EB;
    }
    /* .stat-box {
        border: 1px solid black;
        margin: 20px;
        padding: 10px;
        display: inline-block;
        background-color: #132B2C; 
        color: #FFFFFF; 
        text-align: center; 
        font-family: Jura;
        width: 200px; 
        border-radius: 10px; 
    } */
    #stats {
            font-family: Jura, sans-serif;
        }
        #stats h2 {
            color: #000000;
        }
        #stats table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 20px;

        }
        /* #stats tr {
            background-color: rgb(6, 38, 3);
            color: #ddd;
        } */

        #stats td {
            border: 2px solid #000000;
            padding: 8px;
            text-align: center;
            font-size: 24px;
        }
        #stats tr:nth-child(5n+1) {
            background-color: black;
            color: white;
        }
        #stats tr:nth-child(5n+1) td {
            /* text-align: right; */
            font-size: 28px; 
        }
        #stats tr:nth-child(5n+1):hover {
            background-color: #000000;
        }
        #stats tr:hover {
            background-color: #ddd;
        }
</style>

    <h1>{{ filename }}</h1>
    <h1>JOURNEY</h1>

    <!-- Loading Indicator -->
    <div id="loading" style="display: none;">
        Generating map, please wait...
    </div>

    <!-- iframe initially hidden -->
    <iframe id="mapFrame" src="" style="width: 100%; height: 600px; display: none;"></iframe>

    <div id="stats">
        <h2>Track Stats</h2>
        {% if stats %}
        <table>
            {% for stat_name, stat_value in stats.items() %}
            <tr>
                <td>{{ stat_name }}</td>
                <td>{{ stat_value }}</td>
            </tr>
            {% endfor %}
        </table>
        {% else %}
        <div style="border: 2px solid rgb(178, 0, 0); padding: 10px; margin: 5px; text-align: center;background-color: #000000;border-radius: 10px;">
            <p style="color: red;font-family: Jura;font-size: 32px; font-weight: bolder;">NO STATS AVAILABLE UPLOAD FILE WITH TRACK POINTS TO VIEW STATS</p>
        </div>
        {% endif %}
    </div>
    
    <h3>ELEVATION CHARTS</h3>
    <div id="elevation-charts" style="display: flex; flex-direction: column; margin-top: 10px;">
        {% for data in elevation_data %}
            <div style="margin: 10px; background-color: #000000; border-radius: 10px;">
                <h4>{{ data.name }}</h4>
                <canvas id="elevation-chart-{{ loop.index }}"></canvas>
                <script>
                    var ctx = document.getElementById('elevation-chart-{{ loop.index }}').getContext('2d');
                    var elevationData = {{ data.elevation | tojson }};
                    var elevationChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: Array.from(Array(elevationData.length).keys()), // Assuming each elevation point corresponds to a track point
                            datasets: [{
                                label: 'Elevation',
                                data: elevationData,
                                backgroundColor: 'rgba(250, 250,250, 1)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 3,
                                lineTension: 0,
                                pointRadius: 0
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        color: 'white'
                                    }
                                },
                            x: {
                                    ticks: {
                                    color: 'white'
                                    }
                                }
                            }
                        }
                    });
                </script>
            </div>
        {% endfor %}
    </div>


    <script>
        document.getElementById('loading').style.display = 'block';
    
        // Function to check if the map is ready
        function checkMapStatus() {
            var xhr = new XMLHttpRequest(); // Declaring the xhr variable
            xhr.open('GET', '/check_map_status/{{ filename }}', true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    var response = JSON.parse(xhr.responseText);
                    if (response.map_ready) {
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('mapFrame').style.display = 'block';
                        document.getElementById('mapFrame').src = '{{ map_url }}';
                    } else {
                        setTimeout(checkMapStatus, 4000); // Check again after 4 seconds
                    }
                }
            };
            xhr.send();
        }

        checkMapStatus();

    </script>
    

{% endblock %}
